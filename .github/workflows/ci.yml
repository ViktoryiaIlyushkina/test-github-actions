name: ASP.NET Core CI

on:
  pull_request:
    branches: [ "main" ]

jobs:
  # ЭТАП 1: Сборка и проверка качества кода
  Build_and_Lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' # Укажите нужную версию SDK

      - name: Restore dependencies
        run: dotnet restore

      - name: Build Project
        run: dotnet build --no-restore --configuration Release

      # Можно добавить проверку форматирования кода (dotnet format)
      - name: Check Code Format
        run: dotnet format --verify-no-changes --no-restore

  # ЭТАП 2: Тестирование (запускается после успешной сборки)
  Test:
    needs: Build_and_Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Run Tests
        run: dotnet test --configuration Release --verbosity normal

  # ЭТАП 3: Публикация и создание ZIP-архива
  Publish:
    needs: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish API
        run: dotnet publish -c Release -o ./publish

      - name: Zip Artifacts
        run: zip -r build-artifact.zip ./publish

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-api-binary
          path: build-artifact.zip
          retention-days: 5